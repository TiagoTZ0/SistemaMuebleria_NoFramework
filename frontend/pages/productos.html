<style>
    .content-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        /* CORRECCIÓN VISUAL: Altura mínima reservada */
        min-height: 300px; 
        /* Alineación al inicio para que el loader se centre bien arriba si es necesario */
        align-content: start; 
    }

    /* Animación de entrada */
    .product-card {
        animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="page-header" style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
    <h1 style="color: white; font-size: 2.5rem; font-weight: 800; margin: 0; letter-spacing: 1px;">Gestión de Productos</h1>
    <button class="btn btn-white" onclick="showProductForm()" style="font-weight: 700; padding: 0.8rem 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        + Agregar Producto
    </button>
</div>

<div class="content-card">
    
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <input type="text" id="searchInput" placeholder="Buscar por nombre o SKU..." class="filter-input" onkeyup="filterProducts()" style="flex-grow: 1;">
        
        <button class="btn btn-secondary" onclick="toggleFilters()" style="white-space: nowrap; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-filter"></i> Filtrar
        </button>
    </div>

    <div id="filterContainer" class="filter-controls" style="display: none; margin-bottom: 1.5rem; background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); animation: slideDown 0.3s ease-out;">
        
        <select id="proveedorFilter" class="filter-select" onchange="filterProducts()">
            <option value="">Todos los Proveedores</option>
            <option value="1">DormiFlex</option>
            <option value="2">OffiTop</option>
            <option value="3">CasaHome</option>
            <option value="4">MaderaVira</option>
        </select>

        <select id="categoriaFilter" class="filter-select" onchange="filterProducts()">
            <option value="">Todas las Categorías</option>
            <option value="1">Camas</option>
            <option value="2">Mesas</option>
            <option value="3">Sillas</option>
            <option value="4">Estantes</option>
        </select>

        <select id="sortFilter" class="filter-select" onchange="filterProducts()">
            <option value="name-asc">Nombre (A-Z)</option>
            <option value="name-desc">Nombre (Z-A)</option>
            <option value="price-asc">Precio (Menor a Mayor)</option>
            <option value="price-desc">Precio (Mayor a Menor)</option>
            <option value="stock-asc">Stock (Menor a Mayor)</option>
            <option value="stock-desc">Stock (Mayor a Menor)</option>
        </select>
    </div>

    <div id="productCountHeader" style="color: var(--text-secondary-gray); font-size: 0.9rem; margin-bottom: 1.5rem; height: 20px;"></div>
    
    <div class="product-grid" id="productosGrid">
    </div>
</div>

<div style="display: none;" id="formContainer" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color: white; font-size: 1.3rem; margin: 0; font-weight: 700;">Registrar Nuevo Producto</h2>
            <button onclick="hideProductForm()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        
        <div style="background: white; padding: 2rem; border-radius: 0 0 8px 8px;">
            <form id="addProductForm" onsubmit="handleProductSubmit(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    
                    <div>
                        <label class="detail-label">Nombre del Producto *</label>
                        <input type="text" id="nombre" placeholder="Ej: Cama King Size" required class="form-input">
                    </div>
                    
                    <div>
                        <label class="detail-label">SKU *</label>
                        <input type="text" id="sku" placeholder="Ej: CAM-001" required class="form-input">
                    </div>
                    
                    <div>
                        <label class="detail-label">Proveedor *</label>
                        <select id="id_proveedor" required class="form-select">
                            <option value="">Seleccione...</option>
                            <option value="1">DormiFlex</option>
                            <option value="2">OffiTop</option>
                            <option value="3">CasaHome</option>
                            <option value="4">MaderaVira</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="detail-label">Categoría *</label>
                        <select id="id_categoria" required class="form-select">
                            <option value="">Seleccione...</option>
                            <option value="1">Camas</option>
                            <option value="2">Mesas</option>
                            <option value="3">Sillas</option>
                            <option value="4">Estantes</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="detail-label">Precio (S/) *</label>
                        <input type="number" id="precio" placeholder="0.00" step="0.01" required class="form-input">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label class="detail-label">Stock Inicial *</label>
                            <input type="number" id="stock" placeholder="0" required class="form-input">
                        </div>
                        <div style="flex: 1;">
                            <label class="detail-label">Stock Mínimo</label>
                            <input type="number" id="stockMinimo" value="5" class="form-input">
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label class="detail-label">Descripción (Opcional)</label>
                    <textarea id="descripcion" placeholder="Detalles del producto..." class="form-input" rows="2"></textarea>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label class="detail-label">Imagen del Producto</label>
                    <div class="image-toggle-container">
                        <label><input type="radio" name="imgSourceType" value="url" checked onchange="toggleImageInput('create', 'url')"> Enlace URL</label>
                        <label><input type="radio" name="imgSourceType" value="file" onchange="toggleImageInput('create', 'file')"> Subir desde PC</label>
                    </div>
                    
                    <input type="text" id="imagen" placeholder="https://..." class="form-input">
                    <input type="file" id="imagenFile" class="form-input" style="display: none;" accept="image/*">
                    <input type="hidden" id="imagenBase64">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" onclick="hideProductForm()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div style="display: none;" id="modalDetalle" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px;">
        
        <div class="modal-header">
            <h2 id="detalleTitulo" style="color: white; font-size: 1.5rem; margin: 0; font-weight: 700;">Detalles del Producto</h2>
            <button onclick="closeDetalle()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        
        <div style="background: white; padding: 2rem; border-radius: 0 0 8px 8px;">
            <form id="editProductForm" onsubmit="handleUpdate(event)">
                <input type="hidden" id="editId">
                
                <div style="display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label class="detail-label">Nombre</label>
                            <input type="text" id="editNombre" class="form-input detail-input" disabled required>
                        </div>
                        <div>
                            <label class="detail-label">Categoría</label>
                            <select id="editCategoria" class="form-select detail-input" disabled>
                                <option value="1">Camas</option>
                                <option value="2">Mesas</option>
                                <option value="3">Sillas</option>
                                <option value="4">Estantes</option>
                            </select>
                        </div>
                        <div>
                            <label class="detail-label">Proveedor</label>
                            <select id="editProveedor" class="form-select detail-input" disabled>
                                <option value="1">DormiFlex</option>
                                <option value="2">OffiTop</option>
                                <option value="3">CasaHome</option>
                                <option value="4">MaderaVira</option>
                            </select>
                        </div>
                        <div>
                            <label class="detail-label">SKU</label>
                            <input type="text" id="editSku" class="form-input detail-input" disabled required>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div>
                                <label class="detail-label">Stock Actual</label>
                                <input type="number" id="editStock" class="form-input" style="background: #e0e0e0; border: none; color: #555; text-align: center; cursor: not-allowed;" disabled title="Solo editable por inventario">
                            </div>
                            <div>
                                <label class="detail-label">Stock Mín</label>
                                <input type="number" id="editStockMin" class="form-input detail-input" disabled>
                            </div>
                            <div>
                                <label class="detail-label">Precio</label>
                                <input type="number" id="editPrecio" class="form-input detail-input" disabled>
                            </div>
                        </div>

                        <div style="flex-grow: 1;">
                            <label class="detail-label">Descripción</label>
                            <textarea id="editDescripcion" class="form-input detail-input" style="height: 100%; resize: none;" disabled></textarea>
                        </div>
                    </div>
                </div>

                <div style="display: flex; align-items: end; justify-content: space-between; margin-top: 1rem;">
                    
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                         <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 120px; height: 80px; border-radius: 8px; overflow: hidden; background: #eee; border: 1px solid #ddd;">
                                <img id="editImgPreview" src="" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            
                            <div id="editImageControls" style="display: none; flex-direction: column; gap: 5px;">
                                <div class="image-toggle-container">
                                    <label><input type="radio" name="editImgSourceType" value="url" checked onchange="toggleImageInput('edit', 'url')"> URL</label>
                                    <label><input type="radio" name="editImgSourceType" value="file" onchange="toggleImageInput('edit', 'file')"> PC</label>
                                </div>
                                <input type="text" id="editImagenUrlInput" placeholder="URL..." class="form-input" style="width: 200px; padding: 5px; font-size: 0.85rem;">
                                <input type="file" id="editImagenFileInput" style="width: 200px; display:none;" accept="image/*">
                                <input type="hidden" id="editImagenFinal">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; align-items: center;">
                        
                        <div id="viewButtons" style="display: flex; gap: 1rem;">
                            <button type="button" onclick="closeDetalle()" class="btn btn-primary" style="background: #1565C0; width: 100px;">Cerrar</button>
                            <button type="button" onclick="enableEditMode()" class="btn btn-primary" style="width: 100px;">Editar</button>
                            <button type="button" onclick="deleteFromModal()" style="background: #A63A3A; color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>

                        <div id="editButtons" style="display: none; gap: 1rem;">
                            <button type="button" onclick="cancelEditMode()" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-success" style="background: #28a745; color: white; border: none;">Guardar Cambios</button>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
</div>